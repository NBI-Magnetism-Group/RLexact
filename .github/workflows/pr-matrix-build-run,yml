
name: PR â€” Matrix Build & Run

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build: #build-and-run:
    #name: Build & Run (${{ matrix.os }} / mpi=${{ matrix.mpi }})
    #runs-on: ${{ matrix.os }}

    #strategy:
    #  fail-fast: false
    #  matrix:
    #    os: [ubuntu-22.04, macos-14]
    #    mpi: [none, mpich]
    #    include:
    #      - os: ubuntu-22.04
    #        shell: bash
    #      - os: macos-14
    #        shell: bash

    env:
      # Adjust these for your project
      MAKE_TARGET: ""                           # e.g. "RLexact" or "all"; leave blank to run `make`
      EXECUTABLE_PATH: "./RLexact"              # expected output after make
      EXEC_ARGS: "../RLexamples/test.h/"        # arguments to pass when running
      RUN_LAUNCHER: ""                          # e.g. "mpirun -np 1"; leave empty to run directly
      CXX_STD: "-std=c++17"
      WARNINGS: "-Wall -Wextra -Wpedantic"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------- Linux setup ----------
      - name: Install build dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-22.04'
        run: sudo apt install libopenmpi-dev

      # ---------- macOS setup ----------
      - name: Install build dependencies (macOS)
        if: matrix.os == 'macos-14'
        run: |
          brew update
          brew install llvm make
          brew install mpich
      # --------- General commands in bash -------
      - name: Show toolchain versions
        shell: bash
        run: |
          set -euxo pipefail
          echo "Compiler:"
          c++ --version || true
          clang --version || true
          which mpic++ || true
          mpic++ --version || true
          echo "Make:"
          make --version

      - name: Build with make
        shell: bash
        env:
          CXXFLAGS: "${{ env.CXX_STD }} ${{ env.WARNINGS }}"
        run: |
          echo "Running make ${MAKE_TARGET}"
          make ${MAKE_TARGET} 2>&1 | tee build-${{ matrix.os }}-${{ matrix.mpi }}.log

      - name: Run executable
        shell: bash
        run: |
          if [ ! -x "${EXECUTABLE_PATH}" ]; then
            echo "Executable not found or not executable: ${EXECUTABLE_PATH}"
            exit 1
          fi

          if [ -n "${RUN_LAUNCHER}" ]; then
            echo "Launching with: ${RUN_LAUNCHER} ${EXECUTABLE_PATH} ${EXEC            echo "Launching with: ${RUN_LAUNCHER} ${EXECUTABLE_PATH} ${EXEC_ARGS}"
            ${RUN_LAUNCHER} "${EXECUTABLE_PATH}" ${EXEC_ARGS} 2>&1 | tee run-${{ matrix.os }}-${{ matrix.mpi }}.log
          else
            echo "Launching: ${EXECUTABLE_PATH} ${EXEC_ARGS}"
            "${EXECUTABLE_PATH}" ${EXEC_ARGS} 2>&1 | tee run-${{ matrix.os }}-${{ matrix.mpi }}.log
          fi

      - name: Upload logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.os }}-${{ matrix.mpi }}-${{ github.run_id }}
          path: |
            build-${{ matrix.os }}-${{ matrix.mpi }}.log
